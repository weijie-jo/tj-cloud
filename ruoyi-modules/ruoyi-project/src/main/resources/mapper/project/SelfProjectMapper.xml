<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper
        PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN"
        "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.ruoyi.project.mapper.SelfProjectMapper">

    <resultMap type="com.ruoyi.project.domain.SelfProject" id="SelfProjectResult">
        <result property="projectId"    column="project_id"    />
        <result property="projectCode"    column="project_code"    />
        <result property="projectName"    column="project_name"    />
        <result property="projectTrade"    column="project_trade"    />
        <result property="projectOwner"    column="project_owner"    />
        <result property="purchCompany"    column="purch_company"    />
        <result property="projectTotalAmount"    column="project_total_amount"    />
        <result property="projectLeader"    column="project_leader"    />
        <result property="projectGrossMargin"    column="project_gross_margin"    />
        <result property="projectGrossProfit"    column="project_gross_profit"    />
        <result property="projectNetProfit"    column="project_net_profit"    />
        <result property="projectPackageAmount"    column="project_package_amount"    />
        <result property="projectDesc"    column="project_desc"    />
        <result property="projectStatus"    column="project_status"    />
        <result property="isDeleted"    column="is_deleted"    />
        <result property="createBy"    column="create_by"    />
        <result property="updateBy"    column="update_by"    />
        <result property="createTime"    column="create_time"    />
        <result property="updateTime"    column="update_time"    />
        <result property="checkContent"    column="check_content"    />
        <result property="fileName"    column="file_name"    />
        <result property="projectTimeStart"    column="project_time_start"    />
        <result property="projectTimeEnd"    column="project_time_end"    />
        <result property="projectCheckStatus"    column="project_check_status"    />
        <result property="projectTicketStatus"    column="project_ticket_status"    />
        <result property="projectContractStatus"    column="project_contract_status"    />
        <result property="projectAcceptanceStatus"    column="project_acceptance_status"    />
        <result property="projectDutypaidStatus"    column="project_dutypaid_status"    />
        <result property="placeCode"    column="place_code"    />
        <result property="purchCompanyTaxid"    column="purchCompanyTaxid"    />
        <result property="selfName"    column="self_name"    />
        <result property="ticketType"    column="ticket_type"    />
        <result property="ticketTax"    column="ticket_tax"    />
        <result property="projectOwnerTaxid"    column="project_owner_taxid"    />
        <result property="projectRemainAmount"    column="project_remain_amount"    />
        <result property="ticketRemark"    column="ticket_remark"    />
        <result property="contractRemark"    column="contract_remark"    />
        <result property="checkRemark"    column="check_remark"    />
        <result property="taxRemark"    column="tax_remark"    />
        <result property="fileName1"    column="file_name1"    />
        <result property="fileName2"    column="file_name2"    />
        <result property="fileName3"    column="file_name3"    />
        <result property="userId"    column="user_id"    />
        <result property="endStatus"    column="end_status"    />
        <result property="endTime"    column="end_time"    />
    </resultMap>

    <sql id="selectSelfProjectVo">
        select project_owner_taxid,ticket_type,ticket_tax,self_name,project_id, project_code, project_name, project_trade,
               project_owner, purch_company, project_total_amount, project_leader, project_gross_margin, project_gross_profit,
               project_net_profit, project_package_amount, project_desc, project_status, is_deleted, create_by, update_by,
               create_time, update_time, check_content, file_name, project_time_start, project_time_end, project_check_status,
               project_ticket_status, project_contract_status, project_acceptance_status, project_dutypaid_status,
               place_code,purch_company_taxid,project_remain_amount ,ticket_remark, contract_remark, check_remark, tax_remark,
               file_name1, file_name2, file_name3, user_id  ,end_status, end_time from self_project
    </sql>
<!--    A.ticket_id, A.project_code, A.ticket_amount, A.ticket_type, A.ticket_content, A.ticket_remark,-->
<!--    A.ticket_tax, A.ticket_code, A.ticket_time, A.file_name, A.ticket_type_code, A.create_by, A.update_by,-->
<!--    A.create_time, A.update_time,-->
    <sql id="selectProjectJoinTicketByCodeVo">
        select t.project_id, t.project_code, t.project_name, t.project_trade, t.project_owner, t.purch_company,
               t.project_total_amount, t.project_leader, t.project_gross_margin, t.project_gross_profit,
               t.project_net_profit, t.project_package_amount, t.project_desc, t.project_status, t.is_deleted,
               t.create_by, t.update_by, t.create_time, t.update_time, t.check_content, t.file_name, t.project_time_start,
               t.project_time_end, t.project_check_status, t.project_ticket_status, t.project_contract_status,
               t.project_acceptance_status, t.project_dutypaid_status, t.place_code,t.purch_company_taxid,t.self_name,
               t.ticket_type,t.ticket_tax,t.project_owner_taxid,t.project_remain_amount,t.user_id,t.end_status, t.end_time,
                t.ticket_remark, t.contract_remark, t.check_remark, t.tax_remark, t.file_name1, t.file_name2, t.file_name3,
               B.self_name,B.tax_id,B.nature_business,B.industry_type,B.industry_tax,B.is_active,
                C.place_name,C.place_status
            from self_project t  JOIN self_employed B ON t.project_owner = B.self_code
                                JOIN business_place C ON t.place_code = C.place_code
    </sql>
    <select id="selectProjectJoinTicketByCode" parameterType="String" resultType="com.ruoyi.project.domain.vo.ProjectJoinTicketVo">
        <include refid="selectProjectJoinTicketByCodeVo"/>
        where  AND t.project_code=#{projectCode}
    </select>
    <select id="selectSelfProjectList"  resultMap="SelfProjectResult">
        <include refid="selectSelfProjectVo"/>
        <where>
            <if test="selfProject.endStatus == 0  ">AND end_status =0 </if>
            <if test="selfProject.endStatus == 1  ">AND end_status =1 AND DATE_FORMAT(end_time,'%Y-%m-%d')>=DATE_SUB(CURDATE(),INTERVAL 7 DAY)</if>
            <if test="selfProject.endStatus == 2  ">AND end_status =2 </if>
            <if test="selfProject.projectCode != null  and selfProject.projectCode != ''"> and project_code = #{selfProject.projectCode}</if>
            <if test="selfProject.projectName != null  and selfProject.projectName != ''"> and project_name like concat('%', #{selfProject.projectName}, '%')</if>
            <if test="selfProject.projectTrade != null  and selfProject.projectTrade != ''"> and project_trade = #{selfProject.projectTrade}</if>
            <if test="selfProject.projectOwner != null  and selfProject.projectOwner != ''"> and project_owner = #{selfProject.projectOwner}</if>
            <if test="selfProject.purchCompany != null  and selfProject.purchCompany != ''"> and purch_company = #{selfProject.purchCompany}</if>
            <if test="selfProject.projectTotalAmount != null "> and project_total_amount = #{selfProject.projectTotalAmount}</if>
            <if test="selfProject.projectLeader != null  and selfProject.projectLeader != ''"> and project_leader = #{selfProject.projectLeader}</if>
            <if test="selfProject.projectGrossMargin != null "> and project_gross_margin = #{selfProject.projectGrossMargin}</if>
            <if test="selfProject.projectGrossProfit != null "> and project_gross_profit = #{selfProject.projectGrossProfit}</if>
            <if test="selfProject.projectNetProfit != null "> and project_net_profit = #{selfProject.projectNetProfit}</if>
            <if test="selfProject.projectPackageAmount != null "> and project_package_amount = #{selfProject.projectPackageAmount}</if>
            <if test="selfProject.projectDesc != null  and selfProject.projectDesc != ''"> and project_desc = #{selfProject.projectDesc}</if>
            <if test="selfProject.projectStatus != null "> and project_status = #{selfProject.projectStatus}</if>
            <if test="selfProject.isDeleted != null  and selfProject.isDeleted != ''"> and is_deleted = #{selfProject.isDeleted}</if>
            <if test="selfProject.checkContent != null  and selfProject.checkContent != ''"> and check_content = #{selfProject.checkContent}</if>
            <if test="selfProject.fileName != null  and selfProject.fileName != ''"> and file_name like concat('%', #{fselfProject.ileName}, '%')</if>
            <if test="selfProject.start != null and selfProject.start != ''"><!-- 开始时间检索 -->
                AND date_format(project_time_start,'%Y-%m-%d %H:%i:%s') >= date_format(#{selfProject.start},'%Y-%m-%d %H:%i:%s')
            </if>
            <if test="selfProject.end != null and selfProject.end != ''"><!-- 结束时间检索 -->
                AND date_format(project_time_start,'%Y-%m-%d %H:%i:%s') &lt;= date_format(#{selfProject.end},'%Y-%m-%d %H:%i:%s')
            </if>
            <if test="selfProject.projectCheckStatus != null  and selfProject.projectCheckStatus != ''"> and project_check_status = #{selfProject.projectCheckStatus}</if>
            <if test="selfProject.projectTicketStatus != null  and selfProject.projectTicketStatus != ''"> and project_ticket_status = #{selfProject.projectTicketStatus}</if>
            <if test="selfProject.projectContractStatus != null  and selfProject.projectContractStatus != ''"> and project_contract_status = #{selfProject.projectContractStatus}</if>
            <if test="selfProject.projectAcceptanceStatus != null  and selfProject.projectAcceptanceStatus != ''"> and project_acceptance_status = #{selfProject.projectAcceptanceStatus}</if>
            <if test="selfProject.projectDutypaidStatus != null  and selfProject.projectDutypaidStatus != ''"> and project_dutypaid_status = #{selfProject.projectDutypaidStatus}</if>
            <if test="selfProject.placeCode != null  and selfProject.placeCode != ''"> and place_code = #{selfProject.placeCode}</if>
            <if test="selfProject.purchCompanyTaxid != null  and selfProject.purchCompanyTaxid != ''"> and purch_company_taxid = #{selfProject.purchCompanyTaxid}</if>
            <if test="selfProject.selfName != null  and selfProject.selfName != ''"> and self_name like concat('%', #{selfProject.selfName}, '%')</if>
            <if test="selfProject.ticketType != null "> and ticket_type = #{selfProject.ticketType}</if>
            <if test="selfProject.ticketTax != null "> and ticket_tax = #{selfProject.ticketTax}</if>
            <if test="selfProject.projectOwnerTaxid != null  and selfProject.projectOwnerTaxid != ''"> and project_owner_taxid = #{selfProject.projectOwnerTaxid}</if>
            <if test="selfProject.projectRemainAmount != null "> and project_remain_amount = #{selfProject.projectRemainAmount}</if>
            <if test="selfProject.ticketRemark != null  and selfProject.ticketRemark != ''"> and ticket_remark = #{selfProject.ticketRemark}</if>
            <if test="selfProject.contractRemark != null  and selfProject.contractRemark != ''"> and contract_remark = #{selfProject.contractRemark}</if>
            <if test="selfProject.checkRemark != null  and selfProject.checkRemark != ''"> and check_remark = #{selfProject.checkRemark}</if>
            <if test="selfProject.taxRemark != null  and selfProject.taxRemark != ''"> and tax_remark = #{selfProject.taxRemark}</if>
            <if test="selfProject.fileName1 != null  and selfProject.fileName1 != ''"> and file_name1 = #{selfProject.fileName1}</if>
            <if test="selfProject.fileName2 != null  and selfProject.fileName2 != ''"> and file_name2 = #{selfProject.fileName2}</if>
            <if test="selfProject.fileName3 != null  and selfProject.fileName3 != ''"> and file_name3 = #{selfProject.fileName3}</if>
            <if test="userIdArr != null  and userIdArr.size() >0 ">
                AND user_id in
                <foreach collection="userIdArr" index="index" item="item" open="(" close=")" separator=",">
                    #{item}
                </foreach>
            </if>
        </where>
        ORDER BY
        create_time DESC
    </select>

    <select id="selectSelfProjectByProjectId" parameterType="String" resultMap="SelfProjectResult">
        <include refid="selectSelfProjectVo"/>
        where  project_id = #{projectId}
    </select>
    <select id="selectLast" resultMap="SelfProjectResult">
        <include refid="selectSelfProjectVo"/>
        ORDER BY project_id DESC LIMIT 0,1
    </select>

    <insert id="insertSelfProject" parameterType="com.ruoyi.project.domain.SelfProject" useGeneratedKeys="true" keyProperty="projectId">
        insert into self_project
        <trim prefix="(" suffix=")" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">project_code,</if>
            <if test="projectName != null and projectName != ''">project_name,</if>
            <if test="projectTrade != null">project_trade,</if>
            <if test="projectOwner != null">project_owner,</if>
            <if test="purchCompany != null">purch_company,</if>
            <if test="projectTotalAmount != null">project_total_amount,</if>
            <if test="projectLeader != null">project_leader,</if>
            <if test="projectGrossMargin != null">project_gross_margin,</if>
            <if test="projectGrossProfit != null">project_gross_profit,</if>
            <if test="projectNetProfit != null">project_net_profit,</if>
            <if test="projectPackageAmount != null">project_package_amount,</if>
            <if test="projectDesc != null">project_desc,</if>
            <if test="projectStatus != null">project_status,</if>
            <if test="isDeleted != null">is_deleted,</if>
            <if test="createBy != null">create_by,</if>
            <if test="updateBy != null">update_by,</if>
            <if test="createTime != null">create_time,</if>
            <if test="updateTime != null">update_time,</if>
            <if test="checkContent != null">check_content,</if>
            <if test="fileName != null">file_name,</if>
            <if test="projectTimeStart != null">project_time_start,</if>
            <if test="projectTimeEnd != null">project_time_end,</if>
            <if test="projectCheckStatus != null">project_check_status,</if>
            <if test="projectTicketStatus != null">project_ticket_status,</if>
            <if test="projectContractStatus != null">project_contract_status,</if>
            <if test="projectAcceptanceStatus != null">project_acceptance_status,</if>
            <if test="projectDutypaidStatus != null">project_dutypaid_status,</if>
            <if test="placeCode != null">place_code,</if>
            <if test="purchCompanyTaxid != null">purch_company_taxid,</if>
            <if test="selfName != null">self_name,</if>
            <if test="ticketType != null">ticket_type,</if>
            <if test="ticketTax != null">ticket_tax,</if>
            <if test="projectOwnerTaxid != null">project_owner_taxid,</if>
            <if test="projectRemainAmount != null">project_remain_amount,</if>
            <if test="ticketRemark != null">ticket_remark,</if>
            <if test="contractRemark != null">contract_remark,</if>
            <if test="checkRemark != null">check_remark,</if>
            <if test="taxRemark != null">tax_remark,</if>
            <if test="fileName1 != null">file_name1,</if>
            <if test="fileName2 != null">file_name2,</if>
            <if test="fileName3 != null">file_name3,</if>
            <if test="userId != null">user_id,</if>
            <if test="endStatus != null">end_status,</if>
            <if test="endTime != null">end_time,</if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">#{projectCode},</if>
            <if test="projectName != null and projectName != ''">#{projectName},</if>
            <if test="projectTrade != null">#{projectTrade},</if>
            <if test="projectOwner != null">#{projectOwner},</if>
            <if test="purchCompany != null">#{purchCompany},</if>
            <if test="projectTotalAmount != null">#{projectTotalAmount},</if>
            <if test="projectLeader != null">#{projectLeader},</if>
            <if test="projectGrossMargin != null">#{projectGrossMargin},</if>
            <if test="projectGrossProfit != null">#{projectGrossProfit},</if>
            <if test="projectNetProfit != null">#{projectNetProfit},</if>
            <if test="projectPackageAmount != null">#{projectPackageAmount},</if>
            <if test="projectDesc != null">#{projectDesc},</if>
            <if test="projectStatus != null">#{projectStatus},</if>
            <if test="isDeleted != null">#{isDeleted},</if>
            <if test="createBy != null">#{createBy},</if>
            <if test="updateBy != null">#{updateBy},</if>
            <if test="createTime != null">#{createTime},</if>
            <if test="updateTime != null">#{updateTime},</if>
            <if test="checkContent != null">#{checkContent},</if>
            <if test="fileName != null">#{fileName},</if>
            <if test="projectTimeStart != null">#{projectTimeStart},</if>
            <if test="projectTimeEnd != null">#{projectTimeEnd},</if>
            <if test="projectCheckStatus != null">#{projectCheckStatus},</if>
            <if test="projectTicketStatus != null">#{projectTicketStatus},</if>
            <if test="projectContractStatus != null">#{projectContractStatus},</if>
            <if test="projectAcceptanceStatus != null">#{projectAcceptanceStatus},</if>
            <if test="projectDutypaidStatus != null">#{projectDutypaidStatus},</if>
            <if test="placeCode != null">#{placeCode},</if>
            <if test="purchCompanyTaxid != null">#{purchCompanyTaxid},</if>
            <if test="selfName != null">#{selfName},</if>
            <if test="ticketType != null">#{ticketType},</if>
            <if test="ticketTax != null">#{ticketTax},</if>
            <if test="projectOwnerTaxid != null">#{projectOwnerTaxid},</if>
            <if test="projectRemainAmount != null">#{projectRemainAmount},</if>
            <if test="ticketRemark != null">#{ticketRemark},</if>
            <if test="contractRemark != null">#{contractRemark},</if>
            <if test="checkRemark != null">#{checkRemark},</if>
            <if test="taxRemark != null">#{taxRemark},</if>
            <if test="fileName1 != null">#{fileName1},</if>
            <if test="fileName2 != null">#{fileName2},</if>
            <if test="fileName3 != null">#{fileName3},</if>
            <if test="userId != null">#{userId},</if>
            <if test="endStatus != null">#{endStatus},</if>
            <if test="endTime != null">#{endTime},</if>
        </trim>
    </insert>

    <update id="updateSelfProject" parameterType="com.ruoyi.project.domain.SelfProject">
        update self_project
        <trim prefix="SET" suffixOverrides=",">
            <if test="projectCode != null and projectCode != ''">project_code = #{projectCode},</if>
            <if test="projectName != null and projectName != ''">project_name = #{projectName},</if>
            <if test="projectTrade != null">project_trade = #{projectTrade},</if>
            <if test="projectOwner != null">project_owner = #{projectOwner},</if>
            <if test="purchCompany != null">purch_company = #{purchCompany},</if>
            <if test="projectTotalAmount != null">project_total_amount = #{projectTotalAmount},</if>
            <if test="projectLeader != null">project_leader = #{projectLeader},</if>
            <if test="projectGrossMargin != null">project_gross_margin = #{projectGrossMargin},</if>
            <if test="projectGrossProfit != null">project_gross_profit = #{projectGrossProfit},</if>
            <if test="projectNetProfit != null">project_net_profit = #{projectNetProfit},</if>
            <if test="projectPackageAmount != null">project_package_amount = #{projectPackageAmount},</if>
            <if test="projectDesc != null">project_desc = #{projectDesc},</if>
            <if test="projectStatus != null">project_status = #{projectStatus},</if>
            <if test="isDeleted != null">is_deleted = #{isDeleted},</if>
            <if test="createBy != null">create_by = #{createBy},</if>
            <if test="updateBy != null">update_by = #{updateBy},</if>
            <if test="createTime != null">create_time = #{createTime},</if>
            <if test="updateTime != null">update_time = #{updateTime},</if>
            <if test="checkContent != null">check_content = #{checkContent},</if>
            <if test="fileName != null">file_name = #{fileName},</if>
            <if test="projectTimeStart != null">project_time_start = #{projectTimeStart},</if>
            <if test="projectTimeEnd != null">project_time_end = #{projectTimeEnd},</if>
            <if test="projectCheckStatus != null">project_check_status = #{projectCheckStatus},</if>
            <if test="projectTicketStatus != null">project_ticket_status = #{projectTicketStatus},</if>
            <if test="projectContractStatus != null">project_contract_status = #{projectContractStatus},</if>
            <if test="projectAcceptanceStatus != null">project_acceptance_status = #{projectAcceptanceStatus},</if>
            <if test="projectDutypaidStatus != null">project_dutypaid_status = #{projectDutypaidStatus},</if>
            <if test="placeCode != null">place_code = #{placeCode},</if>
            <if test="purchCompanyTaxid != null">purch_company_taxid = #{purchCompanyTaxid},</if>
            <if test="selfName != null">self_name = #{selfName},</if>
            <if test="ticketType != null">ticket_type = #{ticketType},</if>
            <if test="ticketTax != null">ticket_tax = #{ticketTax},</if>
            <if test="projectOwnerTaxid != null">project_owner_taxid = #{projectOwnerTaxid},</if>
            <if test="projectRemainAmount != null">project_remain_amount = #{projectRemainAmount},</if>
            <if test="ticketRemark != null">ticket_remark = #{ticketRemark},</if>
            <if test="contractRemark != null">contract_remark = #{contractRemark},</if>
            <if test="checkRemark != null">check_remark = #{checkRemark},</if>
            <if test="taxRemark != null">tax_remark = #{taxRemark},</if>
            <if test="fileName1 != null">file_name1 = #{fileName1},</if>
            <if test="fileName2 != null">file_name2 = #{fileName2},</if>
            <if test="fileName3 != null">file_name3 = #{fileName3},</if>
            <if test="userId != null">user_id = #{userId},</if>
            <if test="endStatus != null">end_status = #{endStatus},</if>
            <if test="endTime != null">end_time = #{endTime},</if>
        </trim>
        where project_id = #{projectId}
    </update>

    <delete id="deleteSelfProjectByProjectId" parameterType="String">
        delete from self_project where project_id = #{projectId}
    </delete>

    <delete id="deleteSelfProjectByProjectIds" parameterType="String">
        delete from self_project where project_id in
        <foreach item="projectId" collection="array" open="(" separator="," close=")">
            #{projectId}
        </foreach>
    </delete>

    <update id="deleteSelfProjectByProjectId2" parameterType="String">
        update self_project
        set is_deleted=0
        where project_id = #{projectId}
    </update>

    <update id="deleteSelfProjectByProjectIds2" parameterType="String">
        update self_project
        set is_deleted=0
        where project_id in
        <foreach item="projectId" collection="array" open="(" separator="," close=")">
            #{projectId}
        </foreach>
    </update>

    <insert id="recycle1" >
        INSERT into self_project_recycle SELECT *FROM self_project WHERE project_code=#{projectCode}
    </insert>
    <insert id="recycle2" >
        INSERT into project_check_recycle SELECT *FROM project_check WHERE project_code=#{projectCode}
    </insert>

    <delete id="deleteProjectByCode" parameterType="String">
        delete from self_project where project_code =#{projectCode}
    </delete>
    <delete id="deleteCheckByCode" parameterType="String">
        delete from project_check where project_code =#{projectCode}
    </delete>
</mapper>